name: AppApiStack.BuildTest.Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'backend/src/apis/app_api/**'
      - 'backend/pyproject.toml'
      - 'backend/Dockerfile.app-api'
      - 'infrastructure/lib/app-api-stack.ts'
      - 'scripts/stack-app-api/**'
      - '.github/workflows/app-api.yml'
  pull_request:
    paths:
      - 'backend/src/apis/app_api/**'
      - 'backend/pyproject.toml'
      - 'backend/Dockerfile.app-api'
      - 'infrastructure/lib/app-api-stack.ts'
      - 'scripts/stack-app-api/**'
      - '.github/workflows/app-api.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'
      skip_deploy:
        description: 'Skip deployment'
        required: false
        default: 'false'

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-west-2' }}
  CDK_PROJECT_PREFIX: ${{ vars.CDK_PROJECT_PREFIX || 'agentcore' }}

# Ensure only one deployment runs at a time
concurrency:
  group: app-api-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-test:
    name: Build and Test App API
    runs-on: ubuntu-latest
    
    # Use OIDC for secure AWS authentication (needed for ECR push)
    permissions:
      id-token: write
      contents: read
    
    outputs:
      image-tag: ${{ steps.push-ecr.outputs.IMAGE_TAG }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          bash scripts/common/install-deps.sh
      
      - name: Install app-api dependencies
        run: |
          bash scripts/stack-app-api/install.sh
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run app-api tests
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          bash scripts/stack-app-api/test.sh
      
      - name: Build Docker image
        env:
          CDK_PROJECT_PREFIX: ${{ env.CDK_PROJECT_PREFIX }}
        run: |
          bash scripts/stack-app-api/build.sh
      
      - name: Test Docker image
        env:
          CDK_PROJECT_PREFIX: ${{ env.CDK_PROJECT_PREFIX }}
        run: |
          bash scripts/stack-app-api/test-docker.sh          
      
      - name: Configure AWS credentials
        uses: ./.github/actions/configure-aws-credentials
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Push to ECR
        id: push-ecr
        env:
          CDK_AWS_ACCOUNT: ${{ secrets.CDK_AWS_ACCOUNT }}
          CDK_AWS_REGION: ${{ env.AWS_REGION }}
          CDK_PROJECT_PREFIX: ${{ env.CDK_PROJECT_PREFIX }}
        run: |
          bash scripts/stack-app-api/push-to-ecr.sh
          echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy App API Stack
    runs-on: ubuntu-latest
    needs: build-and-test
    # if: |
    #   github.event_name == 'push' || github.event_name == 'workflow_dispatch' &&
    #   github.event.inputs.skip_deploy != 'true'
    
    # Use OIDC for secure AWS authentication
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: ./.github/actions/configure-aws-credentials
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-AppApi-CDK
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}     
        
      - name: Install system dependencies
        run: |
          bash scripts/common/install-deps.sh
      
      - name: Deploy App API Stack
        env:
          CDK_AWS_ACCOUNT: ${{ secrets.CDK_AWS_ACCOUNT }}
          CDK_AWS_REGION: ${{ env.AWS_REGION }}
          CDK_PROJECT_PREFIX: ${{ env.CDK_PROJECT_PREFIX }}
          CDK_VPC_CIDR: ${{ vars.CDK_VPC_CIDR || '10.0.0.0/16' }}
          IMAGE_TAG: ${{ needs.build-and-test.outputs.image-tag }}
        run: |
          bash scripts/stack-app-api/deploy.sh
      
      - name: Tag image as latest
        env:
          CDK_AWS_ACCOUNT: ${{ secrets.CDK_AWS_ACCOUNT }}
          CDK_AWS_REGION: ${{ env.AWS_REGION }}
          CDK_PROJECT_PREFIX: ${{ env.CDK_PROJECT_PREFIX }}
          IMAGE_TAG: ${{ needs.build-and-test.outputs.image-tag }}
        run: |
          bash scripts/stack-app-api/tag-latest.sh
     
      - name: Upload deployment outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: app-api-deployment-outputs
          path: |
            cdk-outputs-app-api.json
          retention-days: 30
      
      - name: Deployment summary
        if: success()
        env:
          IMAGE_TAG: ${{ needs.build-and-test.outputs.image-tag }}
        run: |
          echo "## App API Deployment Successful âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${AWS_REGION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${CDK_PROJECT_PREFIX}" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack**: AppApiStack" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cdk-outputs-app-api.json ]; then
            echo "### Stack Outputs" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat cdk-outputs-app-api.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
