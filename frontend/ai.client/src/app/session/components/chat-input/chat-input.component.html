<!-- Quota warning indicator -->
<app-quota-warning-banner />

<div
    class="relative rounded-2xl shadow-xl outline -outline-offset-1 transition-all duration-200"
    [class]="isFocused()
      ? 'bg-white dark:bg-slate-800 outline-2 outline-primary-500 dark:outline-gray-400 ring-2 ring-primary-500/20 dark:ring-gray-400/30 shadow-lg'
      : 'bg-white dark:bg-slate-800 outline-1 outline-gray-300 dark:outline-white/10'"
  >
    <!-- File Attachments Area -->
    @if (showFileAttachments()) {
      <div class="border-b border-gray-200 px-4 py-3 dark:border-gray-700">
        <div class="flex flex-wrap gap-2">
          @for (upload of pendingUploads(); track upload.uploadId) {
            <app-file-card
              [pendingUpload]="upload"
              (remove)="onFileRemove($event)"
              (retry)="onFileRetry($event)"
            />
          }
        </div>
      </div>
    }

    <!-- Main Input Area -->
    <div class="relative">
      <label for="user-message" class="sr-only">How can I help you today?</label>
      <textarea
        id="user-message"
        name="user-message"
        rows="1"
        [value]="userInput()"
        (input)="onTextareaInput($event)"
        (keydown)="onKeyDown($event)"
        (focus)="onFocus()"
        (blur)="onBlur()"
        placeholder="How can I help you today?"
        class="block w-full resize-none bg-transparent px-6 py-4 text-base text-gray-900 placeholder:text-gray-500 dark:text-gray-100 dark:placeholder:text-gray-400 focus:outline-hidden overflow-hidden"
        style="min-height: 60px; max-height: 200px;"
      ></textarea>

      <!-- Bottom Controls Bar -->
      <div class="flex items-center justify-between px-4 pb-3">
        <!-- Left Controls -->
        <div class="flex items-center gap-2" role="group" aria-label="Message options">
          <!-- Add Attachment Button -->
          <div
            class="flex size-10 items-center justify-center rounded-lg text-gray-500 dark:text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-700 dark:hover:bg-white/5 dark:hover:text-gray-300 focus-within:outline-2 focus-within:outline-offset-2 focus-within:outline-[var(--color-primary)]"
            appTooltip="Attach file"
            appTooltipPosition="top"
          >
            <input
              type="file"
              class="sr-only"
              (change)="onFileSelect($event)"
              id="file-upload"
              [accept]="acceptedFileTypes"
              multiple
              aria-label="Attach a file"
            />
            <label for="file-upload" class="flex size-full cursor-pointer items-center justify-center">
              <ng-icon name="heroPlus" class="size-5" aria-hidden="true" />
            </label>
          </div>

          <!-- Settings Button -->
          <button
            type="button"
            (click)="toggleSettings()"
            class="flex size-10 items-center justify-center rounded-lg text-gray-500 dark:text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-700 dark:hover:bg-white/5 dark:hover:text-gray-300 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-primary)]"
            aria-label="Open settings"
            appTooltip="Settings"
            appTooltipPosition="top"
          >
            <ng-icon name="heroAdjustmentsHorizontal" class="size-5" aria-hidden="true" />
          </button>

          <!-- History Button -->
          <button
            type="button"
            class="flex size-10 items-center justify-center rounded-lg text-gray-500 dark:text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-700 dark:hover:bg-white/5 dark:hover:text-gray-300 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--color-primary)]"
            aria-label="View history"
            appTooltip="History"
            appTooltipPosition="top"
          >
            <ng-icon name="heroClock" class="size-5" aria-hidden="true" />
          </button>
        </div>

        <!-- Right Controls -->
        <div class="flex items-center gap-3" role="group" aria-label="Model selection and send">
          <!-- Model Selector -->
          <app-model-dropdown />

          <!-- Submit/Stop Button -->
          <button
            type="button"
            (click)="onSubmit()"
            [disabled]="!chatState.isChatLoading() && hasActivePendingUploads()"
            [class]="chatState.isChatLoading()
              ? 'flex size-10 items-center justify-center rounded-full bg-red-500 text-white shadow-sm transition-all hover:bg-red-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-500'
              : 'flex size-10 items-center justify-center rounded-full bg-secondary-500 text-white shadow-sm transition-all hover:bg-secondary-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-secondary-500 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-secondary-500'"
            [attr.aria-label]="chatState.isChatLoading() ? 'Stop generation' : (hasActivePendingUploads() ? 'Upload in progress' : 'Submit message')"
          >
            @if (chatState.isChatLoading()) {
              <!-- Stop Icon -->
              <ng-icon name="heroStop" class="size-5" aria-hidden="true" />
            } @else {
              <!-- Send Icon -->
              <ng-icon name="heroPaperAirplaneSolid" class="size-5" aria-hidden="true" />
            }
          </button>
        </div>
      </div>
    </div>
  </div>
